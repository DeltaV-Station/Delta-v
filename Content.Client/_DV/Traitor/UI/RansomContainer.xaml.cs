using Content.Shared._DV.Traitor;
using Content.Shared.Cargo.Components;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._DV.Traitor.UI;

[GenerateTypedNameReferences]
public sealed partial class RansomContainer : BoxContainer
{
    [Dependency] private readonly IEntityManager _entMan = default!;

    public event Action<NetEntity>? OnPurchase;

    public RansomContainer()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
    }

    public void UpdateRansoms(List<RansomData> ransoms, int balance)
    {
        Visible = ransoms.Count > 0;
        ListingsContainer.RemoveAllChildren();
        foreach (var ransom in ransoms)
        {
            var listing = new RansomListing(ransom);
            listing.UpdateBalance(balance);
            listing.OnPurchase += ent => OnPurchase?.Invoke(ent);
            ListingsContainer.AddChild(listing);
        }
    }

    public void UpdateStation(EntityUid? station)
    {
        if (!_entMan.TryGetComponent<StationBankAccountComponent>(station, out var bank))
            return;

        var balance = bank.Accounts[bank.PrimaryAccount];
        foreach (var control in ListingsContainer.Children)
        {
            if (control is RansomListing listing)
                listing.UpdateBalance(balance);
        }
    }
}
