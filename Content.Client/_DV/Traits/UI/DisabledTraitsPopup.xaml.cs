using Content.Client.UserInterface.Controls;
using Content.Shared._DV.CCVars;
using Content.Shared._DV.Traits;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Configuration;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;

namespace Content.Client._DV.Traits.UI;

[GenerateTypedNameReferences]
public sealed partial class DisabledTraitsPopup : FancyWindow
{
    [Dependency] private readonly IConfigurationManager _cfg = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;

    private bool _initialSkipState;

    public DisabledTraitsPopup(Dictionary<ProtoId<TraitPrototype>, List<string>> disabledTraits)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        InitializeUI(disabledTraits);
        InitializeEvents();
    }

    private void InitializeUI(Dictionary<ProtoId<TraitPrototype>, List<string>> disabledTraits)
    {
        TitleLabel.Text = Loc.GetString("disabled-traits-popup-label");
        MessageLabel.SetMessage(FormattedMessage.FromMarkupOrThrow(
            Loc.GetString("disabled-traits-popup-message")));

        _initialSkipState = _cfg.GetCVar(DCCVars.SkipDisabledTraitsPopup);
        SkipCheckBox.Pressed = _initialSkipState;

        PopulateDisabledTraits(disabledTraits);
    }

    private void PopulateDisabledTraits(Dictionary<ProtoId<TraitPrototype>, List<string>> disabledTraits)
    {
        DisabledTraitsContainer.RemoveAllChildren();

        foreach (var (traitId, reasons) in disabledTraits)
        {
            if (!_prototype.TryIndex(traitId, out var trait))
                continue;

            var container = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Vertical,
                Margin = new Thickness(0, 0, 0, 10)
            };

            // Trait name
            var nameLabel = new Label
            {
                Text = Loc.GetString(trait.Name),
                FontColorOverride = Color.FromHex("#ff6b6b"),
                StyleClasses = { "LabelSubText" }
            };
            container.AddChild(nameLabel);

            // Reasons why it was disabled
            foreach (var reason in reasons)
            {
                var reasonLabel = new RichTextLabel
                {
                    Margin = new Thickness(10, 2, 0, 0)
                };
                reasonLabel.SetMessage(FormattedMessage.FromMarkupOrThrow(
                    Loc.GetString("disabled-traits-popup-reason", ("reason", reason))));
                container.AddChild(reasonLabel);
            }

            DisabledTraitsContainer.AddChild(container);
        }
    }

    private void InitializeEvents()
    {
        OnClose += SaveSkipState;
        ButtonClose.OnPressed += OnClosePressed;
    }

    private void SaveSkipState()
    {
        if (SkipCheckBox.Pressed == _initialSkipState)
            return;

        _cfg.SetCVar(DCCVars.SkipDisabledTraitsPopup, SkipCheckBox.Pressed);
        _cfg.SaveToFile();
    }

    private void OnClosePressed(BaseButton.ButtonEventArgs args)
    {
        Close();
    }
}
